# Скрипты для запуска и управления локальной инсталляцией YDB

## Быстрый старт

1. Настройте переменные в `env.vars` (хост `YDB_HOST`, диск `YDB_DISK`, пароль `YDB_ROOT_PASSWORD` и др.).
2. Положите бинарники `ydbd` и `ydb` в каталог `./app/`.
3. Первый запуск: выполните `./init.sh`.
4. Дальнейшие запуски: `./start.sh`, остановка: `./stop.sh`.

Подробности по скриптам — ниже.

---

## Описание скриптов

### init.sh

**Назначение:** Полная инициализация одноузловой инсталляции YDB с нуля.

> **Внимание:** скрипт переинициализирует инсталляцию и **уничтожает все существующие данные** на указанном диске (`YDB_DISK`). Запускайте только при первом развёртывании или когда полная очистка допустима.

**Действия:**
1. Загружает переменные из `env.vars`.
2. Останавливает уже запущенную БД (вызовом `stop.sh`).
3. Обновляет TLS-сертификаты через `ydb-ca-update.sh`.
4. Копирует сертификаты из CA в каталог `certs/`.
5. Генерирует конфигурацию из шаблона `config.yaml.template` в `config/config.yaml`.
6. Очищает диск командой `ydbd admin bs disk obliterate`.
7. Запускает процесс БД через `start.sh`.
8. Получает токен аутентификации для пользователя `root`.
9. Инициализирует хранилище, создаёт пул хранения и назначает его домену.
10. Добавляет пользователя `user1` в группу `ADMINS`.

**Запуск:** `./init.sh` (из каталога с настроенным `env.vars` и установленным `ydbd` в `./app/`).

---

### start.sh

**Назначение:** Запуск сервера `ydbd` в фоне.

**Действия:**
- Записывает в `logs/server.log` время и данные о запуске.
- Запускает `ydbd server` с конфигом `config/config.yaml`, узлом 1, TLS (ca, mon-cert), портами gRPC 2135, mon 8765, IC 19001.
- Сохраняет PID процесса в `logs/server.pid`.

**Запуск:** `./start.sh` (ожидается наличие `config/`, `certs/`, каталога `logs/` и бинарника `./app/ydbd`).

---

### stop.sh

**Назначение:** Корректная остановка запущенного сервера `ydbd`.

**Действия:**
- Читает PID из `logs/server.pid`.
- Отправляет процессу сигнал `TERM` и ждёт завершения.
- Удаляет файл `logs/server.pid`.

Если файл PID отсутствует, скрипт сообщает об этом и завершается.

**Запуск:** `./stop.sh`.

---

### ydb-ca-update.sh

**Назначение:** Обновление/создание TLS-сертификатов для узлов YDB (собственный CA и сертификаты узлов).

**Примечание:** это модифицированная версия стандартного примера скрипта генерации сертификатов: выпускаемые сертификаты имеют увеличенный срок действия — **10 лет**.

**Действия:**
- Создаёт структуру каталогов `CA/` (secure, certs, nodes).
- При первом запуске генерирует конфиг CA (`ca.cnf`), ключ и сертификат CA.
- Читает список узлов из файла `ydb-ca-nodes.txt` (в родительском каталоге).
- Для каждого узла создаёт конфиг, ключ, CSR, подписанный сертификат и собирает `web.pem`.
- Сохраняет выпущенные сертификаты в `CA/certs/<дата-время>/`.

**Запуск:** вызывается из `init.sh`; при ручном запуске должен выполняться из каталога, где лежит `ydb-ca-nodes.txt` (обычно из корня single-node).

---

## Порядок использования

1. Настроить переменные в `env.vars` (хост, диск, пароль root и т.д.).
2. Первый запуск или полный перезапуск: выполнить `./init.sh`.
3. Обычный запуск уже инициализированной БД: `./start.sh`.
4. Остановка: `./stop.sh`.
