# Скрипты для запуска и управления локальной инсталляцией YDB

## Быстрый старт

1. Настройте переменные в `env.vars` (см. раздел «Конфигурация» ниже).
2. Положите бинарники `ydbd` и `ydb` в каталог `./app/`.
3. Первый запуск: выполните `./init.sh`.
4. Дальнейшие запуски: `./start.sh`, остановка: `./stop.sh`.

Подробности по скриптам и настройкам — ниже.

---

## Конфигурация (env.vars)

Все скрипты читают настройки из файла `env.vars`. Основные переменные:

| Переменная | Описание |
|------------|----------|
| `YDB_HOST` | Имя хоста (используется для подключения клиентов и в конфигурации) |
| `YDB_DISK` | Блочное устройство для хранения данных YDB (рекомендуется 60+ ГБ) |
| `YDB_DOMAIN_NAME` | Имя домена (при значении `local` подключение: `ydb -d /local`) |
| `YDB_CORE_COUNT` | Количество ядер для настройки акторной системы YDB. **Важно:** не должно быть меньше фактически доступного числа vCPU |
| `YDB_ROOT_PASSWORD` | Пароль для пользователя `root` |
| `YDB_CUSTOM_LOGIN` | Логин дополнительного пользователя (создаётся при начальной инициализации) |
| `YDB_CUSTOM_PASSWORD` | Пароль дополнительного пользователя |
| `YDB_PORT_APP` | Порт для подключения приложений (gRPC) |
| `YDB_PORT_UI` | Порт для UI и сбора метрик |
| `YDB_PORT_IC` | Порт interconnect (можно не пробрасывать наружу) |

---

## Описание скриптов

### init.sh

**Назначение:** Полная инициализация одноузловой инсталляции YDB с нуля.

> **Внимание:** скрипт переинициализирует инсталляцию и **уничтожает все существующие данные** на указанном диске (`YDB_DISK`). Запускайте только при первом развёртывании или когда полная очистка допустима.

**Действия:**
1. Загружает переменные из `env.vars`.
2. Останавливает уже запущенную БД (вызовом `stop.sh`).
3. Обновляет TLS-сертификаты через `ydb-ca-update.sh`.
4. Копирует сертификаты из CA в каталог `certs/`.
5. Генерирует конфигурацию из шаблона `config.yaml.template` в `config/config.yaml`.
6. Очищает диск командой `ydbd admin bs disk obliterate`.
7. Запускает процесс БД через `start.sh`.
8. Получает токен аутентификации для пользователя `root`.
9. Инициализирует хранилище, создаёт пул хранения и назначает его домену.
10. Добавляет пользователя из `YDB_CUSTOM_LOGIN` в группу `ADMINS`.

**Запуск:** `./init.sh` (из каталога с настроенным `env.vars` и установленным `ydbd` в `./app/`).

---

### start.sh

**Назначение:** Запуск сервера `ydbd` в фоне.

**Действия:**
- Записывает в `logs/server.log` время и данные о запуске.
- Запускает `ydbd server` с конфигом `config/config.yaml`, узлом 1, включённым TLS (ca, mon-cert), портами из `YDB_PORT_APP`, `YDB_PORT_UI`, `YDB_PORT_IC`.
- Сохраняет PID процесса в `logs/server.pid`.

**Запуск:** `./start.sh` (требуется наличие `config/`, `certs/`, каталога `logs/`, бинарника `./app/ydbd` и настроенных переменных окружения в `env.vars`).

---

### stop.sh

**Назначение:** Корректная остановка запущенного сервера `ydbd`.

**Действия:**
- Читает PID из `logs/server.pid`.
- Отправляет процессу сигнал `TERM` и ждёт завершения.
- Удаляет файл `logs/server.pid`.

Если файл PID отсутствует, скрипт сообщает об этом и завершается.

**Запуск:** `./stop.sh`.

---

### ydb-ca-update.sh

**Назначение:** Обновление/создание TLS-сертификатов для узлов YDB (собственный CA и сертификаты узлов).

**Примечание:** это модифицированная версия стандартного примера скрипта генерации сертификатов: выпускаемые сертификаты имеют увеличенный срок действия — **10 лет**.

**Действия:**
- Создаёт структуру каталогов `CA/` (secure, certs, nodes).
- При первом запуске генерирует конфиг CA (`ca.cnf`), ключ и сертификат CA.
- Читает список узлов из файла `ydb-ca-nodes.txt` (в родительском каталоге).
- Для каждого узла создаёт конфиг, ключ, CSR, подписанный сертификат и собирает `web.pem`.
- Сохраняет выпущенные сертификаты в `CA/certs/<дата-время>/`.

**Запуск:** вызывается из `init.sh`; при ручном запуске должен выполняться из каталога, где лежит файл `ydb-ca-nodes.txt` со списком хостов (в общем сценарии создаётся и заполняется скриптом init.sh).

---

### backup.sh / restore.sh

**Назначение:** Резервное копирование и восстановление данных через `ydb tools dump` / `ydb tools restore`.

**Действия:**
- `backup.sh` — создаёт дамп в `backups/<timestamp>/`, упаковывает его в squashfs (`backups/<timestamp>.squashfs`), использует настройки из `env.vars` (`YDB_HOST`, `YDB_PORT_APP`, `YDB_DOMAIN_NAME`, `YDB_ROOT_PASSWORD`).
- `restore.sh [BACKUP_ID]` — восстанавливает из squashfs-архива указанного или последнего бэкапа.

**Зависимости:** для `restore.sh` требуется `squashfuse` (например, `sudo apt install squashfuse`).

**Запуск:** `./backup.sh`, `./restore.sh` или `./restore.sh 20250219-143022`.

---

## Порядок использования

1. Настроить переменные в `env.vars` (см. раздел «Конфигурация»).
2. Первый запуск или полный перезапуск: выполнить `./init.sh`.
3. Обычный запуск уже инициализированной БД: `./start.sh` (при ручном запуске — предварительно `source ./env.vars`).
4. Остановка: `./stop.sh`.

## Несколько экземпляров на одном сервере

Для запуска нескольких экземпляров YDB на одном сервере требуется:

1. Независимое отдельное устройство хранения данных для каждого экземпляра (например отдельные партиции отказоустойчивого RAID-диска)
2. Собственный непересекающийся набор портов, настроенный в переменных `YDB_PORT_APP`, `YDB_PORT_UI`, `YDB_PORT_IC`
3. Отдельный каталог со скриптами запуска
4. Отдельный каталог для хранения бэкапов

Сертификат CA удобно иметь общий.

Имена доменов лучше настроить разные, чтобы сократить вероятность ошибки при подключении приложения "не к той базе".

Имена и пароли пользователей лучше настроить разные, также для снижения вероятности ошибочных подключений.

Приложения лучше подключать от имени отдельно созданного дополнительного пользователя, оставив root для задач администрирования.
